---

# EXPERIMENTAL Run Drupal update process for drupal-composer projects
# within Drupal-VM environment.
#   - Performs code update.
#   - Calls kentr.drupal post-update tasks.
#   - Installs Wraith (with dependencies).
#   - Sets up project-specific Wraith configuration.
#   - Runs Wraith smoke test on updated code.
#
# Prerequisites:
#   - VM is already set up to run Drupal.
#   - Drupal code exists.
#   - The repo containing the Drupal code has a clean working directory (no local modifications).
#   - Drupal-VM configuration files are present and correct.
#
# Usage:
#   `ansible-playbook provisioning/run-updates.yml`
#
# Extra Variables:
#   - drupal_update_security_only: Boolean. Default = False. If True, only
#     security updates will be applied.
#   - drupal_update_projects: Space-separated list of projects to update,
#     as for `drush pm-updatestatus`.  Default = '' (update all projects).
#
# TODO:
#   - Support non-composer projects.
#   - Move Wraith installation to role.

- hosts: all
  become: No

  vars_files:
    - vars/main.yml
    - ../default.config.yml

  pre_tasks:
    - include: tasks/config.yml
      tags: ['always']

  roles:

  tasks:

  - include_tasks: "{{ playbook_dir }}/../scripts/misc/tasks/do-updates.yml"

  - name: Run wraith smoke test.
    block:
      - include_tasks: "{{ playbook_dir }}/../scripts/misc/tasks/wraith-install.yml"
        when: drupal_updated | default(false) and wraith_testing_framework.install | default(False)

      - include_tasks: "{{ playbook_dir }}/../scripts/post-provision/tasks/general-setup-wraith.yml"
        when: drupal_updated | default(False) and wraith_testing_framework.install | default(False)

      - include_tasks: "{{ playbook_dir }}/../scripts/misc/tasks/wraith-smoke-test.yml"
        when: drupal_updated | default(false) and wraith_testing_framework.install | default(False)
