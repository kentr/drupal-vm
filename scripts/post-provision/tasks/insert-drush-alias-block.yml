---

# Inserts a block for a local Vagrant-based Drush alias.

- name: Ensure local Drush alias file exists.
  delegate_to: 127.0.0.1
  become: no
  template:
    # Don't overwrite existing file.
    force: no
    dest: "~/.drush/{{ drush_alias_file_prefix }}.aliases.drushrc.php"
    src: "{{ playbook_dir }}/../scripts/post-provision/templates/drush.aliases.drushrc.php.j2"

- name: Insert local Drush alias declaration.
  delegate_to: 127.0.0.1
  become: no
  blockinfile:
    dest: "~/.drush/{{ drush_alias_file_prefix | default(vagrant_machine_name) }}.aliases.drushrc.php"
    marker: "// {mark} ANSIBLE MANAGED BLOCK: @{{ drush_alias_file_prefix | default(vagrant_machine_name) }}.loc"
    state: present
    content: |
      $aliases['loc'] = array(
        // vagrant_hostname
        'uri' => '{{ vagrant_hostname }}',
        // drupal_core_path
        'root' => '{{ drupal_core_path }}',
        // vagrant_hostname
        'remote-host' => '{{ vagrant_hostname }}',
        'remote-user' => '{{ vagrant_user }}',
        'ssh-options' => '-o PasswordAuthentication=no -i ' . drush_server_home() . '/.vagrant.d/insecure_private_key',
        'source-command-specific' => array (
          'sql-sync' => array (
            'structure-tables-key' => 'common',
          ),
        ),
        'command-specific' => array (
          'sql-dump' => array (
            'structure-tables-key' => 'common',
          ),
          'archive-dump' => array (
            'structure-tables-key' => 'common',
          ),
        ),
      );
  when: insert_local_drush_alias | default(false)
