---

# Inserts a block for a local Vagrant-based Drush alias.

- name: Ensure local .drush directory exists.
  delegate_to: 127.0.0.1
  become: no
  file:
    path: ~/.drush
    state: directory
    mode: "u+rwx"

- name: Ensure local Drush alias file exists.
  delegate_to: 127.0.0.1
  become: no
  template:
    # Don't overwrite existing file.
    force: no
    dest: "~/.drush/{{ drush_alias_file_prefix }}.aliases.drushrc.php"
    src: "{{ playbook_dir }}/../scripts/post-provision/templates/drush.aliases.drushrc.php.j2"
  when: project_type == "drupal" and insert_local_drush_alias | default(false)

- name: Insert local Drush alias declaration.
  delegate_to: 127.0.0.1
  become: no
  blockinfile:
    dest: "~/.drush/{{ drush_alias_file_prefix | default(vagrant_machine_name) }}.aliases.drushrc.php"
    marker: "// {mark} ANSIBLE MANAGED BLOCK: @{{ drush_alias_file_prefix | default(vagrant_machine_name) }}.local"
    state: present
    content: |
      $aliases['local'] = array(
        // vagrant_hostname
        'uri' => '{{ vagrant_hostname }}',
        // drupal_core_path
        'root' => '{{ drupal_core_path }}',
        // vagrant_hostname
        'remote-host' => '{{ vagrant_hostname }}',
        'remote-user' => '{{ vagrant_user }}',
        'ssh-options' => '-o PasswordAuthentication=no -i ' . drush_server_home() . '/.vagrant.d/insecure_private_key -o LogLevel=quiet',
        'source-command-specific' => array (
          'sql-sync' => array (
            'structure-tables-key' => 'common',
          ),
        ),
        'target-command-specific' => array(
          'sql-sync'  => array(
            'enable'  => array('devel'),
          ),
        ),
        'command-specific' => array (
          'sql-dump' => array (
            'structure-tables-key' => 'common',
          ),
          'archive-dump' => array (
            'structure-tables-key' => 'common',
          ),
          'rsync' => array (
            'mode' => '{{ drush_rsync_mode }}',
            'exclude-paths' => '{{ drush_rsync_excludes }}',
          ),
        ),
      );
  when: project_type == "drupal" and insert_local_drush_alias | default(false)

# Add Drush post-sync hook to enable modules.
# See http://api.drush.ws/api/drush/examples!sync_enable.drush.inc/master.
- name: Add sync_enable.drush.inc.
  delegate_to: 127.0.0.1
  become: no
  template:
    # Don't overwrite existing file.
    force: no
    dest: "~/.drush/sync_enable.drush.inc"
    src: "{{ playbook_dir }}/../scripts/post-provision/templates/sync_enable.drush.inc.j2"
  when: project_type == "drupal" and insert_local_drush_alias | default(false)
